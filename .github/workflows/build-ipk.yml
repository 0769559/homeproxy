name: Build HomeProxy IPK (ipq60xx/aarch64)

on:
  workflow_dispatch:
    inputs:
      homeproxy_commit:
        description: 'HomeProxy提交哈希'
        required: false
        default: '7c7badc'

jobs:
  build-homeproxy-ipk:
    runs-on: ubuntu-22.04
    env:
      MAKEFLAGS: "-j1"  # 单线程避免资源耗尽
    steps:
      # 1. 安装最小化依赖（仅满足HomeProxy编译）
      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
          git libncurses5-dev libssl-dev unzip wget curl swig autoconf automake libtool-bin

      # 2. 克隆ImmortalWRT源码（仅取基础框架，master分支适配ipq60xx）
      - name: Clone Base Source
        run: |
          rm -rf immortalwrt && mkdir -p immortalwrt && cd immortalwrt
          git clone --depth=1 --branch=master https://github.com/immortalwrt/immortalwrt.git .

      # 3. 仅配置HomeProxy Feed和ipq60xx架构
      - name: Configure HomeProxy & Arch
        run: |
          cd immortalwrt
          # 仅添加HomeProxy Feed，删除其他无关feeds
          echo "src-git homeproxy https://github.com/immortalwrt/homeproxy.git^${{ github.event.inputs.homeproxy_commit }}" > feeds.conf.default
          # 更新并仅安装HomeProxy feeds
          ./scripts/feeds update homeproxy
          ./scripts/feeds install -p homeproxy -a

          # 仅写入ipq60xx架构核心配置（无多余选项）
          cat > .config << EOF
          CONFIG_TARGET_qualcommax=y
          CONFIG_TARGET_qualcommax_ipq60xx=y
          CONFIG_TARGET_DEVICE_qualcommax_ipq60xx_DEVICE_generic=y
          CONFIG_ARCH_PACKAGES="aarch64_cortex-a53"
          CONFIG_DEVEL=y
          # 仅启用HomeProxy相关编译
          CONFIG_PACKAGE_luci-app-homeproxy=y
          CONFIG_PACKAGE_homeproxy=y
          EOF
          make defconfig

      # 4. 下载HomeProxy依赖（仅下载相关）
      - name: Download HomeProxy Dependencies
        run: |
          cd immortalwrt
          make download -j1

      # 5. 预编译po2lmo（HomeProxy必需）
      - name: Build po2lmo
        run: |
          cd immortalwrt/feeds/packages/utils/po2lmo
          make && sudo make install

      # 6. 仅编译HomeProxy包（核心：跳过全局编译/安装）
      - name: Compile Only HomeProxy
        run: |
          cd immortalwrt
          # 仅编译homeproxy主包
          make package/homeproxy/compile V=sc
          # 仅编译luci-app-homeproxy前端包
          make package/luci-app-homeproxy/compile V=sc

      # 7. 上传HomeProxy IPK产物
      - name: Upload HomeProxy IPK
        uses: actions/upload-artifact@v4
        with:
          name: homeproxy-ipk-ipq60xx
          path: immortalwrt/bin/packages/aarch64_cortex-a53/homeproxy/
          if-no-files-found: warn
