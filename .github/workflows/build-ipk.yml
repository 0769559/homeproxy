name: Build ImmortalWRT IPK (ipq60xx/aarch64)

on:
  workflow_dispatch:
    inputs:
      immortalwrt_branch:
        description: 'ImmortalWRT 分支'
        required: true
        default: 'openwrt-23.05'
      homeproxy_commit:
        description: 'HomeProxy提交哈希'
        required: false
        default: '7c7badc'

jobs:
  build-ipk:
    runs-on: ubuntu-22.04
    steps:
      # 1. 基础环境初始化（仅保留必要步骤）
      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
          libelf-dev libtool-bin autoconf automake texinfo patch pkg-config curl swig

      # 2. 克隆源码 + 配置HomeProxy Feed（移除所有校验）
      - name: Clone Source & Configure Feed
        run: |
          rm -rf immortalwrt && mkdir -p immortalwrt && cd immortalwrt
          # 直接克隆分支，无任何校验
          git clone --branch=${{ github.event.inputs.immortalwrt_branch }} https://github.com/immortalwrt/immortalwrt.git .
          # 配置HomeProxy Feed（仅保留核心格式）
          sed -i '/homeproxy/d' feeds.conf.default
          echo "src-git homeproxy https://github.com/immortalwrt/homeproxy.git^${{ github.event.inputs.homeproxy_commit }}" >> feeds.conf.default
          # 更新feeds（无容错，直接执行）
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 3. 配置编译（纯手动生成ipq60xx配置，无文件依赖）
      - name: Configure Build
        run: |
          cd immortalwrt
          # 直接写入ipq60xx架构核心配置，无任何目录/文件校验
          cat > .config << EOF
          CONFIG_TARGET_qualcommax=y
          CONFIG_TARGET_qualcommax_ipq60xx=y
          CONFIG_TARGET_DEVICE_qualcommax_ipq60xx_DEVICE_generic=y
          CONFIG_ARCH_PACKAGES="aarch64_cortex-a53"
          CONFIG_DEVEL=y
          EOF
          make defconfig

      # 4. 下载依赖 + 编译IPK（移除多余清理/调试）
      - name: Compile IPK
        run: |
          cd immortalwrt
          # 下载依赖
          make download -j$(nproc)
          # 预编译po2lmo（仅核心命令）
          pushd feeds/packages/utils/po2lmo
          make && sudo make install
          popd
          # 编译IPK
          make package/compile -j$(nproc) V=s

      # 5. 上传产物（保留核心功能）
      - name: Upload IPK
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-ipk-ipq60xx
          path: immortalwrt/bin/packages/aarch64_cortex-a53/
