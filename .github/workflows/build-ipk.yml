name: Build ImmortalWRT IPK (ipq60xx/aarch64)

on:
  workflow_dispatch:
    inputs:
      immortalwrt_branch:
        description: 'ImmortalWRT 分支（推荐：openwrt-23.05 / master）'
        required: true
        default: 'openwrt-23.05'  # 官方有效分支
      immortalwrt_commit:
        description: '源码Commit（留空用分支最新版，267ca5a仅本地有效）'
        required: false
        default: ''  # 清空默认值，避免无效checkout
      target_arch:
        description: '目标架构（你的硬件：qualcommax/ipq60xx）'
        required: true
        default: 'qualcommax/ipq60xx'
      homeproxy_commit:
        description: 'HomeProxy提交哈希（有效值：7c7badc）'
        required: false
        default: '7c7badc'  # 正确的HomeProxy提交哈希

jobs:
  build-ipk:
    runs-on: ubuntu-22.04
    steps:
      - name: Set up job
        uses: actions/checkout@v4

      - name: Install Complete Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
          libelf-dev libtool-bin autoconf automake texinfo patch pkg-config curl swig

      - name: Validate ImmortalWRT Branch
        run: |
          ALLOWED_BRANCHES=("openwrt-23.05" "master" "openwrt-24.03")
          if [[ ! " ${ALLOWED_BRANCHES[@]} " =~ " ${{ github.event.inputs.immortalwrt_branch }} " ]]; then
            echo "错误：不支持的分支名！允许的分支：${ALLOWED_BRANCHES[*]}"
            exit 1
          fi

      - name: Clone ImmortalWRT Source + Fix HomeProxy Feed
        run: |
          mkdir -p immortalwrt && cd immortalwrt
          # 克隆指定分支的最新代码（移除depth=1，避免提交缺失）
          git clone --branch=${{ github.event.inputs.immortalwrt_branch }} https://github.com/immortalwrt/immortalwrt.git .
          
          # 修复：仅当commit不为空且有效时才checkout（避免267ca5a无效提交）
          if [ -n "${{ github.event.inputs.immortalwrt_commit }}" ]; then
            # 增加commit存在性校验
            if git rev-parse --verify ${{ github.event.inputs.immortalwrt_commit }} >/dev/null 2>&1; then
              git checkout ${{ github.event.inputs.immortalwrt_commit }}
            else
              echo "警告：提交${{ github.event.inputs.immortalwrt_commit }}不存在，使用分支最新版"
            fi
          fi
          
          # HomeProxy Feed正确配置（^分隔提交哈希）
          sed -i '/homeproxy/d' feeds.conf.default
          echo "src-git homeproxy https://github.com/immortalwrt/homeproxy.git^${{ github.event.inputs.homeproxy_commit }}" >> feeds.conf.default
          
          # 容错更新feeds
          ./scripts/feeds update -a || true
          ./scripts/feeds install -a
          ./scripts/feeds install homeproxy

      - name: Configure Build (适配ipq60xx架构)
        run: |
          cd immortalwrt
          # 加载ipq60xx默认配置
          cp configs/immortalwrt-${{ github.event.inputs.target_arch }}.config .config
          make defconfig

      - name: Download Dependencies (增加容错)
        run: |
          cd immortalwrt
          make download -j$(nproc)
          # 清理无效依赖文件
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile IPK (修复po2lmo缺失)
        run: |
          cd immortalwrt
          # 预编译po2lmo工具
          pushd feeds/packages/utils/po2lmo
          make && sudo make install
          popd
          # 编译IPK（适配aarch64架构）
          make package/compile -j$(nproc) CONFIG_TARGET=${{ github.event.inputs.target_arch }} V=s

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-ipk-${{ github.event.inputs.target_arch }}
          path: immortalwrt/bin/packages/aarch64_cortex-a53/
