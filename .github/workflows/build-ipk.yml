name: Build ipk for HomeProxy

on:
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼ˆæ ¸å¿ƒï¼Œæ”¯æŒæŒ‡å®š7c7badc/æ¶æ„ç­‰å‚æ•°ï¼‰
  workflow_dispatch:
    inputs:
      immortalwrt_branch:
        description: 'ImmortalWRT åˆ†æ”¯ï¼ˆå¦‚ immortalwrt-23.05ï¼‰'
        required: true
        default: 'openwrt-23.05'
      homeproxy_commit:
        description: 'HomeProxy Commit Hashï¼ˆå¦‚ 7c7badcï¼‰'
        required: true
        default: '7c7badc'
      target_arch:
        description: 'ç›®æ ‡æ¶æ„ï¼ˆå¦‚ aarch64_generic/qualcommax_ipq60xxï¼‰'
        required: true
        default: 'aarch64_generic'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Complete Dependenciesï¼ˆä¿®å¤ç¼–è¯‘ä¾èµ–ç¼ºå¤±ï¼‰
        run: |
          sudo apt update
          # ç§»é™¤ä¸å­˜åœ¨çš„jsonfilterï¼Œä¿ç•™æ ¸å¿ƒä¾èµ–ï¼Œè·³è¿‡upgradeå‡å°‘è€—æ—¶
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget curl meson ninja-build liblua5.1-dev zlib1g-dev fakeroot \
          libssl-dev lua5.1 gettext-base

      - name: Clone ImmortalWRT Source + Fix HomeProxy Feed
        run: |
          mkdir -p immortalwrt && cd immortalwrt
          # å…‹éš†æŒ‡å®šåˆ†æ”¯çš„ImmortalWRTæºç 
          git clone -b ${{ github.event.inputs.immortalwrt_branch }} https://github.com/immortalwrt/immortalwrt.git .
          # é”å®š7c7badc Commitï¼ˆä½ çš„æ ¸å¿ƒéœ€æ±‚ï¼‰
          echo "src-git homeproxy https://github.com/immortalwrt/homeproxy.git;${{ github.event.inputs.homeproxy_commit }}" >> feeds.conf.default
          # åŒé•œåƒæºåŠ é€Ÿï¼ˆä¿®å¤ä¾èµ–ä¸‹è½½å¤±è´¥ï¼‰
          sed -i 's#downloads.immortalwrt.org#mirrors.pku.edu.cn/immortalwrt#' ./feeds.conf.default
          sed -i 's#downloads.openwrt.org#mirrors.tuna.tsinghua.edu.cn/openwrt#' ./feeds.conf.default
          # æ›´æ–°feedsï¼ˆå¢åŠ é‡è¯•æœºåˆ¶ï¼‰
          ./scripts/feeds update -a || ./scripts/feeds update -a -f
          ./scripts/feeds install -a

      - name: Configure Buildï¼ˆé€‚é…ç›®æ ‡æ¶æ„ï¼Œä¿®å¤æ¶æ„ä¸åŒ¹é…ï¼‰
        run: |
          cd immortalwrt
          # æ ¹æ®è¾“å…¥çš„æ¶æ„åŠ¨æ€é…ç½®ï¼ˆå…¼å®¹aarch64/qualcommax_ipq60xxç­‰ï¼‰
          if [[ "${{ github.event.inputs.target_arch }}" == "qualcommax_ipq60xx" ]]; then
            # é€‚é…ä½ çš„qualcommax/ipq60xxè®¾å¤‡
            echo "CONFIG_TARGET_qualcommax=y
            CONFIG_TARGET_qualcommax_ipq60xx=y
            CONFIG_TARGET_qualcommax_ipq60xx_JDCloud_RE-CS-02=y
            # å¯ç”¨HomeProxyåŠå®Œæ•´ä¾èµ–
            CONFIG_PACKAGE_luci-app-homeproxy=m
            CONFIG_PACKAGE_homeproxy=m
            CONFIG_PACKAGE_sing-box=m
            CONFIG_PACKAGE_v2ray-geodata=m
            CONFIG_PACKAGE_luci-compat=m
            CONFIG_PACKAGE_ip-full=m
            CONFIG_PACKAGE_kmod-tun=m
            # ç¼–è¯‘ä¼˜åŒ–
            CONFIG_BUILD_OPTIMIZE=y
            CONFIG_STRIP_ALL=y" > .config
          else
            # é»˜è®¤é€‚é…aarch64_genericï¼ˆARMv8ï¼‰
            echo "CONFIG_TARGET_armvirt=y
            CONFIG_TARGET_armvirt_64=y
            CONFIG_TARGET_armvirt_64_Default=y
            # å¯ç”¨HomeProxyåŠå®Œæ•´ä¾èµ–
            CONFIG_PACKAGE_luci-app-homeproxy=m
            CONFIG_PACKAGE_homeproxy=m
            CONFIG_PACKAGE_sing-box=m
            CONFIG_PACKAGE_v2ray-geodata=m
            CONFIG_PACKAGE_luci-compat=m
            CONFIG_PACKAGE_ip-full=m
            CONFIG_PACKAGE_kmod-tun=m
            # ç¼–è¯‘ä¼˜åŒ–
            CONFIG_BUILD_OPTIMIZE=y
            CONFIG_STRIP_ALL=y" > .config
          fi
          
          # åŠ è½½é…ç½®å¹¶éªŒè¯ï¼ˆä¿®å¤é…ç½®åŠ è½½å¤±è´¥ï¼‰
          make defconfig

      - name: Download Dependenciesï¼ˆå¢åŠ å®¹é”™ï¼‰
        run: |
          cd immortalwrt
          # ä¾èµ–ä¸‹è½½å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆä¿®å¤ä¸‹è½½è¶…æ—¶ï¼‰
          make download -j$(nproc) || make download -j1 V=s

      - name: Compile po2lmoï¼ˆä¿®å¤po2lmoç¼ºå¤±ï¼‰
        run: |
          cd immortalwrt
          # æ‰‹åŠ¨ç¼–è¯‘po2lmoï¼ˆè§£å†³HomeProxyç¼–è¯‘ä¾èµ–ï¼‰
          git clone https://github.com/openwrt/luci.git po2lmo_temp
          cd po2lmo_temp/modules/luci-base/src
          make po2lmo
          sudo cp po2lmo /usr/local/bin/
          cd ../../../../ && rm -rf po2lmo_temp

      - name: Build HomeProxyï¼ˆæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’é”™ï¼‰
        run: |
          cd immortalwrt
          # ç¼–è¯‘HomeProxyï¼ˆå•çº¿ç¨‹ç¼–è¯‘å‡å°‘æŠ¥é”™ï¼Œæ–°æ‰‹å‹å¥½ï¼‰
          make package/luci-app-homeproxy/compile V=s -j1
          make package/homeproxy/compile V=s -j1

      - name: Prepare Release Files
        run: |
          mkdir -p release-files
          # å…¼å®¹ä¸åŒæ¶æ„çš„ipkè·¯å¾„
          cp immortalwrt/bin/packages/**/luci-app-homeproxy_*.ipk release-files/ || true
          cp immortalwrt/bin/packages/**/homeproxy_*.ipk release-files/ || true
          ls -l release-files/

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: homeproxy-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.homeproxy_commit }}
          path: release-files/*.ipk
          retention-days: 90

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: homeproxy-${{ github.event.inputs.homeproxy_commit }}-${{ github.event.inputs.target_arch }}
          name: HomeProxy ${{ github.event.inputs.homeproxy_commit }} (${{ github.event.inputs.target_arch }})
          body: |
            ğŸš€ ç¼–è¯‘å®Œæˆçš„ HomeProxy IPK åŒ…
            - Commit Hash: ${{ github.event.inputs.homeproxy_commit }}
            - æ¶æ„: ${{ github.event.inputs.target_arch }}
            - ImmortalWRT åˆ†æ”¯: ${{ github.event.inputs.immortalwrt_branch }}
          files: release-files/*.ipk
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
