name: Build ImmortalWRT IPK (ipq60xx/aarch64)

on:
  workflow_dispatch:
    inputs:
      immortalwrt_branch:
        description: 'ImmortalWRT 分支（切换为master解决兼容性）'
        required: true
        default: 'master'  # 核心修改：从openwrt-23.05切换到master分支
      immortalwrt_commit:
        description: '源码Commit（留空用分支最新版）'
        required: false
        default: ''
      target_arch:
        description: '目标架构（你的硬件：qualcommax/ipq60xx）'
        required: true
        default: 'qualcommax/ipq60xx'
      homeproxy_commit:
        description: 'HomeProxy提交哈希（有效值：7c7badc）'
        required: false
        default: '7c7badc'

jobs:
  build-ipk:
    runs-on: ubuntu-22.04
    env:
      MAKEFLAGS: "-j1"
      # 核心：禁用linux target安装阶段的严格校验
      CONFIG_SKIP_TARGET_ROOTFS: "y"
    steps:
      - name: Set up job
        uses: actions/checkout@v4

      - name: Install Complete Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
          libelf-dev libtool-bin autoconf automake texinfo patch pkg-config curl swig
          # 补充ipq60xx架构缺失依赖
          sudo apt install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu

      - name: Clone ImmortalWRT Source + Fix HomeProxy Feed
        run: |
          rm -rf immortalwrt && mkdir -p immortalwrt && cd immortalwrt
          # 克隆master分支（解决openwrt-23.05与ipq60xx兼容性）
          git clone https://github.com/immortalwrt/immortalwrt.git .
          git checkout ${{ github.event.inputs.immortalwrt_branch }}
          
          if [ -n "${{ github.event.inputs.immortalwrt_commit }}" ]; then
            if git rev-parse --verify ${{ github.event.inputs.immortalwrt_commit }} >/dev/null 2>&1; then
              git checkout ${{ github.event.inputs.immortalwrt_commit }}
            else
              echo "警告：提交${{ github.event.inputs.immortalwrt_commit }}不存在，使用分支最新版"
            fi
          fi
          
          # 修复HomeProxy Feed + 适配master分支
          sed -i '/homeproxy/d' feeds.conf.default
          echo "src-git homeproxy https://github.com/immortalwrt/homeproxy.git^${{ github.event.inputs.homeproxy_commit }}" >> feeds.conf.default
          
          ./scripts/feeds update -a || true
          ./scripts/feeds install -a
          ./scripts/feeds install homeproxy

      - name: Configure Build (适配ipq60xx + 跳过rootfs校验)
        run: |
          cd immortalwrt
          rm -f .config
          cat > .config << EOF
          CONFIG_TARGET_qualcommax=y
          CONFIG_TARGET_qualcommax_ipq60xx=y
          CONFIG_TARGET_DEVICE_qualcommax_ipq60xx_DEVICE_generic=y
          CONFIG_TARGET_BOARD="qualcommax"
          CONFIG_TARGET_SUBTARGET="ipq60xx"
          CONFIG_ARCH_PACKAGES="aarch64_cortex-a53"
          CONFIG_CPU_TYPE="cortex-a53"
          CONFIG_DEVEL=y
          CONFIG_BUILD_IPK=y
          # 仅编译HomeProxy，排除冲突包
          CONFIG_PACKAGE_luci-app-homeproxy=y
          CONFIG_PACKAGE_homeproxy=y
          CONFIG_ALL_NONSHARED=n
          CONFIG_ALL_KMODS=n
          CONFIG_ALL_PACKAGES=n
          # 核心：跳过linux target安装的严格校验
          CONFIG_SKIP_TARGET_ROOTFS=y
          CONFIG_SKIP_PACKAGE_CHECK=y
          EOF
          make defconfig

      - name: Download Dependencies
        run: |
          cd immortalwrt
          make download -j1
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile IPK (绕过toplevel.mk严格校验)
        run: |
          cd immortalwrt
          pushd feeds/packages/utils/po2lmo || true
          make && sudo make install
          popd
          # 核心：直接编译HomeProxy包，跳过全局install阶段
          make package/homeproxy/compile V=sc
          make package/luci-app-homeproxy/compile V=sc

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-ipk-${{ github.event.inputs.target_arch }}
          path: immortalwrt/bin/packages/aarch64_cortex-a53/
          if-no-files-found: warn
