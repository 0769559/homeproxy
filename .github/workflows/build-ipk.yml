name: Build ipk for HomeProxy

on:
  workflow_dispatch:
    inputs:
      immortalwrt_branch:
        description: 'ImmortalWRT åˆ†æ”¯ï¼ˆå¦‚ immortalwrt-23.05ï¼‰'
        required: true
        default: 'immortalwrt-23.05'
      homeproxy_commit:
        description: 'HomeProxy Commit Hashï¼ˆå¦‚ 7c7badcï¼‰'
        required: true
        default: '7c7badc'
      target_arch:
        description: 'ç›®æ ‡æ¶æ„ï¼ˆå¦‚ aarch64_genericï¼‰'
        required: true
        default: 'aarch64_generic'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget curl

      - name: Clone ImmortalWRT Source
        run: |
          mkdir -p immortalwrt && cd immortalwrt
          # å…‹éš† ImmortalWRT æºç ï¼ˆåŒ¹é…ä½ çš„è®¾å¤‡ï¼‰
          git clone -b ${{ github.event.inputs.immortalwrt_branch }} https://github.com/immortalwrt/immortalwrt.git .
          # æ·»åŠ æŒ‡å®š Commit Hash çš„ HomeProxy feedï¼ˆé”å®š7c7badcç‰ˆæœ¬ï¼‰
          echo "src-git homeproxy https://github.com/immortalwrt/homeproxy.git;${{ github.event.inputs.homeproxy_commit }}" >> feeds.conf.default
          # æ›¿æ¢å›½å†…é•œåƒæºåŠ é€Ÿä¸‹è½½
          sed -i 's#downloads.immortalwrt.org#mirrors.pku.edu.cn/immortalwrt#' ./feeds.conf.default
          # æ›´æ–°å¹¶å®‰è£… feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure Build
        run: |
          cd immortalwrt
          # é…ç½® aarch64_generic æ¶æ„ï¼ˆåŒ¹é…ä½ çš„ARMv8è®¾å¤‡ï¼‰
          echo "CONFIG_TARGET_armvirt=y
          CONFIG_TARGET_armvirt_64=y
          CONFIG_TARGET_armvirt_64_Default=y
          # å¯ç”¨ HomeProxy åŠä¾èµ–ï¼ˆç¼–è¯‘ä¸ºipkåŒ…ï¼‰
          CONFIG_PACKAGE_luci-app-homeproxy=m
          CONFIG_PACKAGE_homeproxy=m
          CONFIG_PACKAGE_sing-box=m
          CONFIG_PACKAGE_v2ray-geodata=m
          # å…³é—­ä¸å¿…è¦çš„ç¼–è¯‘é¡¹åŠ é€Ÿç¼–è¯‘
          CONFIG_BUILD_OPTIMIZE=y
          CONFIG_STRIP_ALL=y" > .config
          
          # åŠ è½½å¹¶éªŒè¯é…ç½®
          make defconfig

      - name: Download Dependencies
        run: |
          cd immortalwrt
          # ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¤±è´¥è‡ªåŠ¨é‡è¯•ï¼‰
          make download -j$(nproc) || make download -j1 V=s

      - name: Build HomeProxy
        run: |
          cd immortalwrt
          # ç¼–è¯‘ HomeProxy ç›¸å…³ipkåŒ…ï¼ˆæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼‰
          make package/luci-app-homeproxy/compile V=s -j$(nproc)
          make package/homeproxy/compile V=s -j$(nproc)

      - name: Prepare Release Files
        run: |
          # æ•´ç†ç¼–è¯‘äº§ç‰©ï¼Œæ–¹ä¾¿ä¸Šä¼ 
          mkdir -p release-files
          cp immortalwrt/bin/packages/**/luci-app-homeproxy_*.ipk release-files/
          cp immortalwrt/bin/packages/**/homeproxy_*.ipk release-files/
          # åˆ—å‡ºäº§ç‰©ç¡®è®¤
          ls -l release-files/

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: homeproxy-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.homeproxy_commit }}
          path: release-files/*.ipk
          retention-days: 90  # Artifactä¿ç•™90å¤©

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # Releaseæ ‡ç­¾ï¼ˆåŒ…å«ç‰ˆæœ¬å’Œæ¶æ„ï¼Œä¾¿äºè¯†åˆ«ï¼‰
          tag_name: homeproxy-${{ github.event.inputs.homeproxy_commit }}-${{ github.event.inputs.target_arch }}
          # Releaseæ ‡é¢˜
          name: HomeProxy ${{ github.event.inputs.homeproxy_commit }} (${{ github.event.inputs.target_arch }})
          # Releaseæè¿°
          body: |
            ğŸš€ è‡ªåŠ¨ç¼–è¯‘çš„ HomeProxy IPK åŒ…
            - Commit Hash: ${{ github.event.inputs.homeproxy_commit }}
            - æ¶æ„: ${{ github.event.inputs.target_arch }}
            - ImmortalWRT åˆ†æ”¯: ${{ github.event.inputs.immortalwrt_branch }}
            - ç¼–è¯‘æ—¶é—´: ${{ github.run_at }}
          # ä¸Šä¼ äº§ç‰©åˆ°Release
          files: release-files/*.ipk
          # è®¾ä¸ºé¢„å‘å¸ƒï¼ˆå¯é€‰ï¼Œé¿å…è¯¯è§¦æ­£å¼ç‰ˆï¼‰
          prerelease: true
        env:
          # GitHubè‡ªåŠ¨ç”Ÿæˆçš„Tokenï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
